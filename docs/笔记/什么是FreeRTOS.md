## 什么是FreeRTOS？

---

## 提要

本文将FreeRTOS与市面主流RTOS进行横向对比，并简要概括了FreeRTOS内核的主要功能与实现

---

## 笔记

#### RTOS

**实时操作系统**（Real-time operating system, RTOS），又称**即时操作系统**，它会按照排序执行、管理系统资源，并为开发应用程序提供一致的基础。$^{(1)}$当外界事件或数据产生时，能够接受并以足够快的速度予以处理，其处理的结果又能在规定的时间之内来控制生产过程或对处理系统做出快速响应，调度一切可利用的资源完成实时任务，并控制所有实时任务协调一致运行的操作系统。提供__及时响应__和__高可靠性__是其主要特点。$^{(2)}$

#### 常见的RTOS

##### VxWorks

VxWorks 操作系统是美国WindRiver公司于1983年设计开发的一种__商业化嵌入式实时操作系统__。它以其良好的可靠性和卓越的实时性被广泛地应用在通信、军事、航空、航天等高精尖技术及实时性要求极高的领域中，如卫星通讯、军事演习军事演习、弹道制导、飞机导航等。VxWorks具有强实时性、微内核设计、可裁剪性、可移植性和可靠性等特点，能较好地满足嵌入式开发的需求。缺点就是昂贵的价格让开发者望而却步。

##### FreeRTOS

FreeRTOS是一个开源的专门__面向微控制器和小型微处理器的迷你的实时操作系统内核__。$^{(3)}$FreeRTOS 系统简单、小巧、易用，通常情况下内核占用 4k-9k 字节的空间。具有高可移植性，代码主要 C 语言编写。其免费的优点使得其受到许多开发者的青睐。

##### μC/OS-II

μC/OS-II 是一种__基于优先级的开源抢占式多任务实时操作系统__。与FreeRTOS相比，它支持更多的功能，比如多核、多线程、多用户等。但是也因此需要耗费更多的RAM，不如FreeRTOS小巧。同时该内核赋予各个任务的优先级必须是不相同的。这意味着μC/OS-II不支持时间片轮转调度。

##### TencentOS tiny

TencentOS tiny 是__面向物联网领域开发的实时操作系统__，具有低功耗，低资源占用，模块化，安全可靠等特点，可有效提升物联网终端产品开发效率。

#### FreeRTOS内核实现

##### 系统功能

FreeRTOS提供的功能包括：任务管理、时间管理、信号量、消息队列、内存管理、记录功能等，可基本满足较小系统的需要。FreeRTOS内核支持优先级调度算法，每个任务可根据重要程度的不同被赋予一定的优先级，CPU总是让处于就绪态的、优先级最高的任务先运行。FreeRTOS内核同时支持轮换调度算法，系统允许不同的任务使用相同的优先级，在没有更高优先级任务就绪的情况下，同一优先级的任务共享CPU的使用时间。

##### 原理与实现

###### 任务调度

FreeRTOS采用双向链表的方法来进行任务调度。FreeRTOS定义就绪任务链表数组为xList pxReadyTasksLists[portMAX_PRIORITIES]。一个当优先级为n的任务需要进入就绪态，只需要将任务对应的TCB（任务控制块）中的节点插入到pxReadyTasksLiStS[n]里即可。当进行任务调度时，调度算法首先实现优先级调度。系统按照优先级从高到低的顺序从就绪任务链表数组中寻找usNumberOfItems第一个不为0的优先级，此优先级即为当前最高就绪优先级，据此实现优先级调度。若此优先级下只有一个就绪任务，则此就绪任务进入运行态；若此优先级下有多个就绪任务，则采用轮换调度算法实现多任务轮流执行。

###### 任务管理

FreeRTOS下可实现创建任务、删除任务、挂起任务、恢复任务、设定任务优先级、获得任务相关信息等功能。当调用sTaskCreate()函数创建一个新的任务时，FreeRTOS首先为新任务分配所需的内存。若内存分配成功，则初始化任务控制块的任务名称、堆栈深度和任务优先级，然后根据堆栈的增长方向初始化任务控制块的堆栈。接着，FreeRTOS把当前创建的任务加入到就绪任务链表。最后再由任务调度算法根据优先级判断是否需要进行任务的切换。

###### 内存分配

除了可采用malloc()和free()函数外，FreeRTOS还提供了另外两种内存分配的策略。第1种方法是，按照需求内存的大小简单地把一大块内存分割为若干小块，每个小块的大小对应于所需求内存的大小。这样做的好处是比较简单，执行时间可严格确定但是内存不能有效释放。第2种方法是，采用链表分配内存，可实现动态的创建、删除任务或队列。优点是能根据任务需要高效率地使用内存，但是存在频繁申请和释放内存后内存碎片化（空闲的内存在地址上不连续）的缺点$^{(4)}$

（1）[实时操作系统 - 维基百科](https://zh.wikipedia.org/wiki/实时操作系统)

（2）[实时操作系统_百度百科](https://baike.baidu.com/item/实时操作系统/357530?fromtitle=RTOS&fromid=987080&fr=aladdin)

（3）[FreeRTOS官方网站](https://www.freertos.org/zh-cn-cmn-s/index.html)

（4）[FreeRTOS_百度百科](https://baike.baidu.com/item/FreeRTOS/9786143?fr=aladdin)
