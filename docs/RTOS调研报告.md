# RTOS调研报告

## （一）项目背景

​        嵌入式系统诞生于20世纪70年代，最早应用于工业领域。作为信息技术革命的产物，它极大的提高了社会生产力。随着嵌入式系统应用到国防、航天、电力、医疗、通信、金融等领域，人们在处理速度、处理精度、实时性等方面对嵌入式系统提出了更高的要求，于是，实时操作系统(RTOS)在这种时代背景下应运而生。

### 发展阶段：

1. #### 第一阶段  

   1980s ~ 2009年左右：RTOS主要是以本机MCU资源管理为主，MCU资源管理的优化及可扩展性等。

2. #### 第二阶段 

   2009年~2020年左右：物联网的产生和发展，拓展了RTOS的应用。尤其是伴随着通信连接技术，如Wi-Fi、蓝牙等为代表的无线技术迅速发展，众多的公司也推出了各种物联网平台，为物联网应用提供了强大的平台支撑，RTOS主要作用是在平台连接上。

3. #### 第三阶段 

   2020年以后：随着设备泛连接的发展，以及边缘计算的发生，设备间的互联及互联操作越来越多，需要一个安全可靠的RTOS来管理。设备互连将成为RTOS发展的一个重要方向。

### 发展趋势：

1. RTOS内核向微型化、高可信、高可用、强实时、构件组装化发展；操作系统支撑开发环境向集成化、可调试化、支持模型驱动设计发展；
2. 面向领域特制的RTOS走向开放化、标准规范化、平台化，越来越多的行业标准出台；
3. 传感器网络技术进一步推动嵌入式技术与互联网技术的深层次耦合，嵌入式产品将成为互联网的主要终端之一，RTOS可能成为互联网接入设备的基础。
4. 设备智能化程度越来越高，MCU固件功能日益增多，而随着MCU性能不断地提升，可实现的应用功能也不断增加。同时，中间件或组件丰富和扩展也是RTOS发展的巨大推动力。
5. 人工智能（AI）技术不断地发展，RTOS将成为其关键的基础。

​	经过数十年的发展，RTOS已经产生了一套完整且成熟的理论体系。目前，国际上有数十家软件开发商涉足RTOS系统研发，市场上有多达上百种实时操作系统。在众多RTOS中，FreeRTOS、WinCE、VxWorks、μC/OS-Ⅱ等运用较广，而Linux在部分网络开发社区的改造下一定程度上也能成为实时操作系统。

​	本小组选择FreeRTOS作为调研和改进的对象。FreeRTOS是一个热门的嵌入式设备用即时操作系统核心，它于2003年由Richard Barry设计，并已被经成功移植到35种不同的微控制器上，采用MIT许可证许可。

### FreeRTOS的优势在于：

1. #### 设计小巧且简易

   整个核心代码只有3到4个C文件，占用了较少的系统资源，是为数不多能够在小RAM单片机上运行的RTOS。

2. #### 代码可读性强

   为了让代码容易阅读、移植和维护，大部分的代码都是以C语言编写，只有一些函数采用汇编语言编写，拥有较强的可读性，对于本组的工作来说工作量适宜。

3. #### 免费开源

   最重要的一点在于，相对μC/OS-II、embOS等商业操作系统，FreeRTOS操作系统是完全免费的操作系统，具有源码公开、可移植、可裁减、调度策略灵活的特点，可以方便地移植到各种单片机上运行。

   ## （二）立项依据

   FreeRTOS虽然已经发展二十余年，但是在实际特定场景的使用中依然存在一些需要解决的问题。而正是基于这个原因，我们小组决定对FreeRTOS进行改进和优化，使其能满足生产中各种不同的需求。

   ### FreeRTOS缺陷：

   1. #### 安全性差

      这主要体现在FreeRTOS并没有提供较好的内存保护机制，以及访问控制、身份验证及加密等安全机制。有关内存保护机制，FreeRTOS并没有操作系统概念中所谓的内核态与用户态的区分，任何一个用户定义的任务都可以对任意内存地址中的内容进行修改，这意味着一个错误的或者恶意的程序有可能会将内核有关的区域进行修改导致系统的崩溃。另一方面，FreeRTOS也没有很好的对栈溢出检测的方式，目前的FreeRTOS仅会在任务切换的时候检测栈指针是否越界，在这种检测方式下，如果任务栈在越界后，又在任务切换之前回到了正常区域内，操作系统无法得知栈以外的内存遭到修改。而对于后者，近年来物联网迅速发展，FreeRTOS必将在其中扮演重要角色，对于一个联网的操作系统，如果没有很好的身份验证和加密等安全机制，则难以在物联网的市场中占据一席之地。

   2. #### 不支持MMU

      使用MMU可以对内存地址的访问进行控制、提升物理内存的利用率以及将进程的地址空间隔离。使用MMU可以实现虚拟地址到物理地址的地址映射，从而为编程提供方便统一的内存空间抽象，在用户进程的视角里，进程拥有整个内存空间，因此编程更加方便，不用担心不小心对其他进程的资源进行修改。MMU为进程提供的空间独立性使得系统更为安全。当今的主流操作系统（linux等）均支持MMU，而FreeRTOS仅支持MPU，因此存在的改进空间极大。

   3. #### 任务调度机制不够完善

      不支持可变时间片、可变优先级等调度算法，目前FreeRTOS采用固定优先级+同优先级内时间片调度的方式，灵活度不足，低优先级的任务可能存在饥饿现象。

   4. #### FreeRTOS不支持多核、多处理器

      （本次对FreeRTOS的优化中暂不考虑）

   ### 初拟的优化方案：

   1. #### Rust重写

      FreeRTOS的安全性缺陷很大一部分原因是C语言的不足所造成的。而Rust作为令一门系统编程语言，专注于安全。 Rust在语法上和C++类似，但是能在保证性能的同时提供更好的内存安全，具有高性能、可靠性、安全性、并发性、可移植性等特点。如果我们使用Rust来重构FreeRTOS，那么它将具有更高的安全性和可靠性。

   2. #### MMU

      既然FreeRTOS不支持MMU，我们可以尝试从已有的支持MMU的操作系统中借鉴移植到FreeRTOS里。即使最终不能实现地址映射的功能，我们也可以尝试实现内存读写保护功能，使得操作系统健壮性得到增强。

   3. #### 任务调度算法

      针对任务调度不完善的问题，我们可以相应地增加一些调度算法，以让FreeRTOS得以在各特定场合下能够用相应的调度算法使得CPU效率最大化。

   #### 

   ## （三）前瞻性与重要性

   ### FreeRTOS现状：

   FreeRTOS是一个市场领先的实时操作系统，用于微控制器和小型微处理器。它是与世界领先的芯片公司合作开发了18年，现在每170秒下载一次。它在MIT开源许可下免费分发，包括一个内核和一组不断增长的物联网库，适用于所有行业领域。

   ### 重要性

   FreeRTOS提供了任务管理、时间管理、信号量、消息队列、内存管理、记录功能、软件定时器、协程等功能，可基本满足较小系统的需要
   同时，FreeRTOS具有以下特点：

   1. #### 可靠性

      * 合作伙伴生态系统提供了包括社区贡献、专业支持以及集成的IDE和生产力工具在内的广泛选择。FreeRTOS提供了具有长期支持版本的功能稳定性。FreeRTOS LTS库附带两年的安全更新和关键错误修复。由AWS为FreeRTOS社区维护。这些保证了FreeRTOS的稳定
      * FreeRTOS提供了内存保护机制，可以防止任务越界访问、缓冲区溢出等常见的内存安全问题，提高了系统的可靠性
      * FreeRTOS提供了完善的任务管理机制，包括任务优先级、任务调度、任务间通信等功能，可以有效地避免任务之间的竞争和冲突，保证系统的稳定性和可靠性

   2. #### 易用性

      FreeRTOS提供了详细的预配置演示和物联网参考集成，无需确定如何设置项目。且因其可快速下载、编译，能更快地进入市场。同时FreeRTOS内存大小小，开销低，执行速度快

   3. #### 实时性

      FreeRTOS是一个实时操作系统，能够快速响应外部事件，提高系统的实时性和可靠性

   4. #### 开源性

      FreeRTOS是开源的，且有一个活跃的社区，不断有用户贡献并改进功能

   5. #### 多平台支持

      目前，FreeRTOS已经发展到支持包含X86，Xilinx，Altera等多达30种的硬件平，因此FreeRTOS具有较好的可移植性，可以在多种硬件平台和软件环境中运行，保证了系统的稳定性和可靠性

   正因为这些特点，FreeRTOS被世界领先的公司信任为微控制器和小型微处理器的事实标准，在实时操作系统领域有重要地位。因此，对FreeRTOS的研究就显得很有必要

   ### 前瞻性

   FreeRTOS占用空间微小，被广泛的设备支持；同时，在嵌入式领域，FreeRTOS是不多的同时具有实时性、开源性、可靠性、易用性、多平台支持等特点的嵌入式操作系统，其广阔的应用前景已经越来越受到业内人士的瞩目。
   具体来说，FreeRTOS

   1. #### 支持物联网

      FreeRTOS可以与AWS IoT Core等云服务平台集成，支持物联网应用的开发和部署，满足物联网应用对实时性、低功耗、安全性等方面的需求

   2. #### 支持机器学习

      FreeRTOS可以与AWS的机器学习服务集成，支持在端设备上运行机器学习模型，提高系统的智能化和自主决策能力

   3. #### 社区支持

      FreeRTOS是开源的，有一个活跃的社区，不断提供新的功能和改进，为用户提供了更多的选择和可能性

   这些对新兴技术的支持，并且拥有一个活跃的社区，使得FreeRTOS在未来的发展中有着广阔的应用前景

   ## （四）相关工作

   ### 对于FreeRTOS的相关改进

   #### 1.FreeRTOS任务运行时间统计方法的改进

   FreeRTOS预留了任务运行时间统计接口，但其实现方法具有诸多局限性，比如时间刻度 计数不够精确、中断服务函数处理时间未统计、未考虑时间计数值溢出问题和需要额外配置一个定时器中断等。近年有提出对FreeRTOS任务运行时间统计方法的改进，包括用64bit物理计时器替代定时中断、扩展计数值位宽、增加中断处理时间统计等，使FreeRTOS可以更精确地统计任务运行时间。 

   #### 2.FreeRTOS实时操作系统任务调度的优化

   FreeRTOS在同优先级采用时间片轮转调度算法，当同优先级任务过多时，为了保证任务完成得实时性，需要将时间片分割的很小，造成了系统处理效率的降低。针对此问题有人尝试对FreeRTOS实时操作系统任务调度进行了修改，将同优先级的调度算法改为最短作业优先等其他调度算法，并在一些场景中实现了FreeRTOS性能的提升。

   #### 3.FreeRTOS内存管理的改进

   FreeRTOS 内存管理方案存在分配时间不确定，切割次数较多，利用率低及合并机制不足等缺点。为最大限度减少内存碎片，提高内存利用率，有人尝试采用一种 “精确切割”和“延时合并”相结合的策略来改进FreeRTOS内存管理。在 FreeRTOS 中引入 TLSF（Two-level Segregated Fit）算法数据结构，采用二级位图索引对动态内存进行管理，并改进 TLSF 算法的内存分配和释放过程，提高了 FreeRTOS的内存分配速度，减少了内存碎片率。

   ### FreeRTOS在工业界的应用

   当前，FreeRTOS在工业界得到了广泛的应用。由于其高度可移植性和开源特性，它适用于各种不同的嵌入式系统和微控制器，包括汽车、航空、医疗、能源等多个领域。许多公司和组织都在使用FreeRTOS，如亚马逊、英特尔、飞思卡尔、施耐德电气、欧姆龙等。同时，FreeRTOS社区也在不断发展壮大，提供大量的支持和资源，使得更多的开发者能够快速掌握并使用FreeRTOS。

   #### 1.亚马逊：

   Amazon FreeRTOS是基于FreeRTOS内核的操作系统，它为连接性能力较弱的微控制器提供了可扩展性、可靠性和安全性。Amazon FreeRTOS能够使得开发者在设计和部署IoT设备时更加容易，同时也提供了全面的安全功能，包括安全连接和设备身份验证。

   #### 2.英特尔：

   英特尔的物联网开发平台中，集成了FreeRTOS，使得英特尔的平台具有实时性和低功耗等特点，同时提供了广泛的开发工具和支持。英特尔还使用FreeRTOS来支持其低功耗无线通信解决方案。

   #### 3.飞思卡尔：

   飞思卡尔与FreeRTOS的合作可以追溯到近20年前，他们共同推出了Kinetis软件平台，为客户提供一整套完整的芯片和软件解决方案，包括FreeRTOS操作系统和周边驱动程序等。飞思卡尔的许多MCU板子都搭载了FreeRTOS操作系统。

   #### 4.施耐德电气：

   施耐德电气使用FreeRTOS作为其工业自动化和智能建筑解决方案的操作系统，可支持实时控制和多任务处理，同时具有高度稳定性和安全性。施耐德电气特别使用FreeRTOS在其旗下的Modicon M221系列PLC上。

   #### 5.欧姆龙：

   欧姆龙使用FreeRTOS作为其Omron Sysmac Studio开发环境中的一个重要组成部分。Sysmac Studio是欧姆龙的PLC和工控机器人解决方案，它可以帮助开发者以更加高效和简便的方式设计和部署自动化系统。FreeRTOS使Sysmac Studio具有了实时性和可靠性特点。

   ## （五）总结

​        RTOS 从诞生开始便有着广泛的应用，随着时代的发展，对其性能的要求越来越高。其中FreeRTOS是一个优秀的代表，其具有诸多有点，近年来仍有许多科研和工业界的项目围绕其展开，但是FreeRTOS也有许多的缺点需要进行改进，因此我们小组在经过调研之后，确定了我们的大作业项目——优化FreeRTOS，对其部分性能进行优化提升，使得其能够适应更多的应用环境。



参考文献：

[1]知乎.实时操作系统的前世今生

[2]知乎.MMU原理

[3] 刘林，朱青，何昭晖. FreeRTOS内存管理方案的分析与改进[J]. 计算机工程与应用，2016

[4] 朱迪. FreeRTOS实时操作系统任务调度优化的研究与实现[D]. 南京邮电大学，2016

[5] 安云飞，赵丙风. FreeRTOS任务运行时间统计方法分析与改进[J]. 单片机与嵌入式系统应用，2021

